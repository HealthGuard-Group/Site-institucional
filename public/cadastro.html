<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro</title>
  <link rel="stylesheet" type="text/css" href="css/global.css">
  <link rel="stylesheet" type="text/css" href="css/cadastro.css">
  <link rel="shortcut icon" type="imagex/png" href="../assets/icon/healthguard_icone.png">
</head>

<body>
  <button onclick="history.back()" class="btn-voltar">
    <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="13 16 9 12 13 8"></polyline>
    </svg>
  </button>
  <div class="left">

    <img src="./assets/imgs/HealthGuard_Logomarca_BRANCA_fundo_transparente.png" alt="HealthGuard Logo">
    <h1>Crie sua conta!</h1>
    <p>Cada minuto é precioso, vamos mudar esse jogo! <br> Comece a monitorar suas máquinas.</p>
  </div>
  <div class="right">
    <div class="container">
      <h2>Crie sua conta!</h2>
      <p>Você já possui conta? <a href="login.html">Clique aqui</a></p>

      <div class="subcontainer">
        <div>
          <label>Cód. da Central</label>
          <input id="codigo_input" type="text" placeholder="Digite o código" oninput="validarCodigo()">
        </div>
        <div>
          <label>Nome Completo</label>
          <input id="nome_input" type="text" placeholder="Ex: Marcelo da Silva" style="cursor: not-allowed;" disabled>
        </div>
        <div>
          <label>E-mail</label>
          <input id="email_input" type="text" placeholder="healthguard@example.com" style="cursor: not-allowed;"
            disabled>
        </div>
        <div>
          <label>Senha</label>
          <input id="senha_input" type="password" placeholder="8+ caracteres" oninput="validarSenha()">
        </div>

        <div>
          <label>CPF</label>
          <input id="cpf_input" type="text" placeholder="xxx.xxx.xxx-xx" onchange="validarCPF()" maxlength="14">
        </div>
        <div>
          <label>Confirme a senha</label>
          <input id="confirmacao_senha_input" type="password" placeholder="Digite novamente"
            oninput="validarConfirmarSenha()">
        </div>
      </div>



      <button onclick="cadastrar()">Criar!</button>

      <br>
      <div id="mensagem"></div>

    </div>
  </div>
</body>

</html>
<script>
  var cpf = document.getElementById("cpf_input")
  document.getElementById("cpf_input").addEventListener("input", () => mascaraCPF(cpf))
  function validarCodigo() {
    var codigo = document.getElementById("codigo_input").value
    var nome = document.getElementById("nome_input")
    var email = document.getElementById("email_input")
    email.value = ""
    nome.value = ""
    if (codigo.length != 10) {
      return
    } else {
      fetch(`/usuarios/buscarconvite/${codigo}`, {
        method: "GET",
      })
        .then(resposta => {
          return resposta.json();
        })
        .then(resposta => {
          console.log(resposta)

          if (resposta.length == 0) {

          } else {
            email.value = resposta[0].emailSugerido
            nome.value = resposta[0].nomeSugerido
          }

        })
        .catch(function (resposta) {
          console.log(`Erro no catch: ${resposta}`);
        });
    }
  }
  function validarSenha() {
    var senha = document.getElementById("senha_input")
    if (senha.value.length > 8) {
      senha.style.border = '0.2vh solid #0AA40A'
      senha.style.boxShadow = '#0aa40a38 0px 2px 8px 0px'
    } else {
      senha.style.border = '0.2vh solid #D30808'
      senha.style.boxShadow = '#d308082d 0px 2px 8px 0px'
    }
  }
  function mascaraCPF(cpf) {
    let value = cpf.value.replace(/\D/g, '');

    if (value.length > 11) {
      value = value.substring(0, 11);
    }

    value = value.replace(/(\d{3})(\d)/, '$1.$2')
      .replace(/(\d{3})(\d)/, '$1.$2')
      .replace(/(\d{3})(\d{1,2})$/, '$1-$2');

    cpf.value = value;
  }
  function validarCPF() {
    if (cpf.value.length == 14) {
      cpf.style.border = '0.2vh solid #0AA40A'
      cpf.style.boxShadow = '#0aa40a38 0px 2px 8px 0px'
    } else {
      cpf.style.border = '0.2vh solid #D30808'
      cpf.style.boxShadow = '#d308082d 0px 2px 8px 0px'
    }
  }
  function validarConfirmarSenha() {
    var senha = document.getElementById("senha_input")
    var senha_confirmar = document.getElementById("confirmacao_senha_input")
    if (senha.value == senha_confirmar.value) {
      senha_confirmar.style.border = '0.2vh solid #0AA40A'
      senha_confirmar.style.boxShadow = '#0aa40a38 0px 2px 8px 0px'
    } else {
      senha_confirmar.style.border = '0.2vh solid #D30808'
      senha_confirmar.style.boxShadow = '#d308082d 0px 2px 8px 0px'
    }
  }

  function cadastrar() {
    var nomeVar = nome_input.value
    var emailVar = email_input.value
    var senhaVar = senha_input.value
    var confirmacaoSenhaVar = confirmacao_senha_input.value
    var codigoVar = codigo_input.value
    var cpf_formatado = cpf.value.replace(/[./-]/g, "")
    var cpfVar = cpf_formatado

    if (
      emailVar === "" ||
      senhaVar === "" ||
      confirmacaoSenhaVar === "" ||
      codigoVar === "" ||
      cpfVar === "" ||
      nomeVar === ""
    ) {
      mensagem.innerHTML += `Por favor, preencha todos os campos<br>`
    }

    else {

      if (senhaVar.length < 9) {
        mensagem.innerHTML += `A senha deve ter no mínimo 9 caracteres<br>`
      } else if (senhaVar !== confirmacaoSenhaVar) {
        mensagem.innerHTML += `Erro ao confirmar a senha<br>`
      }

      else if (isNaN(cpfVar) || cpfVar.length !== 11) {
        mensagem.innerHTML += `CPF inválido<br>`
      }

      else if (
        !emailVar.includes("@") ||
        !emailVar.includes(".") ||
        emailVar.startsWith("@") ||
        emailVar.endsWith("@") ||
        emailVar.endsWith(".") ||
        emailVar.indexOf("@") > emailVar.lastIndexOf(".")
      ) {
        mensagem.innerHTML += `E-mail inválido<br>`
      }

      else if (nome_input.value == "") {
        mensagem.innerHTML += `Preencha o nome`
      }

      else {

        fetch("/usuarios/cadastrar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            nomeServer: nomeVar,
            emailServer: emailVar,
            senhaServer: senhaVar,
            cpfServer: cpfVar,
            senhaServer: senhaVar,
            codigoServer: codigoVar,
          }),
        })
          .then(function (resposta) {
            console.log("resposta: ", resposta);



            if (resposta.ok) {
              registrarLogAcao("Cadastro de usuário", "sucesso");

              mensagem.innerHTML = `Cadastro realizado com sucesso! Redirecionando para tela de Login...`;
              setTimeout(() => {
                window.location = "login.html";
              }, 2000)

            } else {
              registrarLogAcao("Cadastro de usuário", "falha");

              mensagem.innerHTML = `Houve um erro ao tentar realizar o cadastro!! <br><br> Verifique se todos os campos estão corretos`;
            }
          })
          .catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);


            registrarLogAcao("Cadastro de usuário", "falha");
          });

        return false;
      }
    }
  }



 function registrarLogAcao(acao, status) {
  fetch("/logAcoes/registrar", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      fkUnidadeAtendimento: null,
      fkLogAcesso: null,
      fkUsuario: null,
      acao: acao,
      statusAcao: status
    })
  });
}


</script>
