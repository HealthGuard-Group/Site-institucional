<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/menu_bar.css">
    <link rel="stylesheet" href="../css/telaPerfil.css">
    <link rel="stylesheet" href="../css/global.css">
    <link rel="shortcut icon" type="imagex/png" href="../assets/icon/healthguard_icone.png">
    <title>Perfil</title>
</head>

<body onload="validarSessao()">
    <!-- Inicio menu lateral  -->
    <div class="menu-lateral">
        <div class="pai-icones-superiores">
            <div id="logo">
                <img src="../assets/imgs/HealthGuard_icone_BRANCO_fundo_transparente.png" alt="HealthGuard"
                    class="icone-logo-pequena">
            </div>
            <br>
            <div class="icone-box" id="monitoramento_redirecionamento">
                <img src="../assets/imgs/icone_monitoramento.png" alt="Foto" class="icone-menu-1">
                <div class="texto-icone oculto">Monitoramento</div>
            </div>
            <hr class="separador">
            <div class="icone-box" id="gestao_redirecionamento">
                <img src="../assets/imgs/icone_gestao_usuarios.png" alt="Foto" class="icone-menu-2">
                <div class="texto-icone oculto">Gestão de funcionários</div>
            </div>
            <hr class="separador">
            <div class="icone-box" id="alertas_redirecionamento">
                <img src="../assets/imgs/icone_alerta.png" alt="Foto" class="icone-menu-3">
                <div class="texto-icone oculto">Histórico de Alertas</div>
            </div>
            <hr class="separador">
            <div class="icone-box" id="gestao_convites">
                <img src="../assets/imgs/icone-convite2.png" alt="Foto" class="icone-menu-2">
                <div class="texto-icone oculto">Convites</div>
            </div>
            <hr class="separador">
            <div class="icone-box" id="suporte_redirecionamento">
                <img src="../assets/imgs/icone_suporte.png" alt="Foto" class="icone-menu-4">
                <div class="texto-icone oculto">Suporte</div>
            </div>
        </div>
        <div class="pai-icones-inferiores">
            <hr class="separador-forte">
            <div class="icone-box-inferior" id="tela_perfil">
                <img src="../assets/imgs/icone_perfil.png" alt="Foto" class="icone-menu-5">
                <div class="texto-icone oculto" id="nome_usuario">Perfil</div>
            </div>
            <hr class="separador">
            <div class="icone-box-inferior" id="sair_conta_redirecionamento">
                <img src="../assets/imgs/icone_log-out.png" alt="Foto" class="icone-menu-6">
                <div class="texto-icone oculto">Sair da conta</div>
            </div>
        </div>
    </div>
    <!-- Fim do menu lateral -->
    <main>
        <h1>Perfil</h1>
    </main>
    <div id="conteudo">


        <div id="Lado-esquerdo">


            <div class="container">
                <h2>Informações pessoais</h2>
                <div id="info-pessoais">

                    <br>
                    <div id="campo_nome">
                        Nome Completo <br>
                        <input type="text" id="ipt_nome"> <br><br>
                    </div>

                    <div id="campo_email">
                        E-mail<br>
                        <input type="text" id="ipt_email"> <br><br>
                    </div>

                    <div style="display: flex; gap: 20px;" id="cpf_permissao">
                        <div id="campo_cpf">
                            CPF <br>
                            <input type="text" name="" id="ipt_cpf" maxlength="14">
                        </div>
                        <div id="campo_permissao">
                            Permissão <br>
                            <input type="text" id="ipt_permissao" disabled>
                        </div>

                    </div>
                    <br>

                    <button onclick="updateDados(ipt_nome.value, ipt_email.value ,ipt_cpf.value )">Salvar
                        Informações</button>

                    <div id="respostaAlterarDados"></div>
                </div>
            </div>
        </div>

        <div id="Lado-direito">
            <div class="container">
                <h2>Redefinir senha</h2>
                <br>
                <div id="redefinir-senha">
                    <div id="campos_rec_senha">

                        <div id="campo_senha_atual">
                            Senha Atual <br>
                            <input type="text" id="ipt_senha">
                        </div>
                        <br>
                        <div id="campo_senha_nova">
                            Nova senha <br>
                            <input type="text" id="ipt_nova">
                        </div>
                        <br>
                        <div id="campo_confirmacao">
                            Confirmar nova senha <br>
                            <input type="text" id="ipt_confirmacao">
                        </div>
                        <br>
                        <button>Salvar Informações</button>
                    </div>
                </div>
            </div>


            <div id="excluir_conta">

                <img src="../assets/imgs/deletar-usuario.png" alt="">

                <p> Excluir Conta </p>
            </div>

            <div id="modal-confirmacao" class="modal-overlay">

                <div class="modal-conteudo">
                    <h2>Excluir Conta</h2>
                    <p>Você tem certeza que deseja excluir sua conta? Esta ação é irreversível.</p>

                    <div class="modal-botoes">
                        <button id="btn-cancelar" class="modal-botao btn-cancelar">Cancelar</button>
                        <button id="btn-confirmar-exclusao" class="modal-botao btn-excluir"
                            onclick="excluir_conta()">Sim, Excluir</button>
                    </div>
                </div>

            </div>


        </div>
    </div>
</body>

</html>
<script src="../js/menu-lateral.js"></script>
<script src="../js/validarSessao.js"></script>
<script>
    // Script do modal de confirmação de exclusão de conta
    document.addEventListener('DOMContentLoaded', () => {

        const botaoAbrirModal = document.getElementById('excluir_conta');
        const modal = document.getElementById('modal-confirmacao');
        const botaoCancelar = document.getElementById('btn-cancelar');
        function abrirModal() {
            modal.classList.add('modal-visivel');
        }
        function fecharModal() {
            modal.classList.remove('modal-visivel');
        }
        botaoAbrirModal.addEventListener('click', abrirModal);
        botaoCancelar.addEventListener('click', fecharModal);
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                fecharModal();
            }
        });
    });
    // Fim do script do modal


    function atualizarDados() {
        var fks = puxarVariaveis()
        var id = fks.idUsuario
        puxardados(id)
    }

    function puxardados(id) {
        fetch(`/usuarios/puxardadosuser/${id}`, {
            method: "GET",
        })
            .then(resposta => {
                return resposta.json();
            })
            .then(resposta => {
                console.log(resposta)
                ipt_nome.value = resposta[0].nome
                ipt_email.value = resposta[0].email
                if (resposta[0].fkPermissoes == 1) {
                    ipt_permissao.value = "Gestor de TI"
                } else {
                    ipt_permissao.value = "Técnico de TI"
                }
                var cpf_cru = resposta[0].cpf
                ipt_cpf.value = mascaraCPF(cpf_cru)
            })

            .catch(function (resposta) {
                console.log(`Erro no catch: ${resposta}`);
            });
    }

    var inputCpf = document.getElementById("ipt_cpf");

    inputCpf.addEventListener("input", function () {
        var valorMascarado = mascaraCPF(inputCpf);
        inputCpf.value = valorMascarado;
    });
    function mascaraCPF(cpf) {
        let value;

        if (cpf.value !== undefined) {
            value = cpf.value;
        } else {
            value = cpf;
        }
        if (!value) return "";
        value = value.replace(/\D/g, '');
        if (value.length > 11) {
            value = value.substring(0, 11);
        }
        value = value.replace(/(\d{3})(\d)/, '$1.$2')
            .replace(/(\d{3})(\d)/, '$1.$2')
            .replace(/(\d{3})(\d{1,2})$/, '$1-$2');

        return value;
    }
    function validacao_info_pessoais() {
        var nome = ipt_nome.value
        var email = ipt_email.value
        var cpf = ipt_cpf.value
        // validar nulo
        if (nome.length == 0 || email.length == 0 || cpf.length == 0) {
             respostaAlterarDados.innerHTML = '<br> <p style="color:red">Preencha todos campos!</p>'
                setTimeout(() => {
                    respostaAlterarDados.innerHTML = ' '; window.location.reload();
                }, 3000);
                
            return false;
        } else
            //validar quantidade de caracteres cpf
            if (cpf.length != 14) {
                
                respostaAlterarDados.innerHTML = '<br> <p style="color:red">Campo CPF inválido!</p>'
                setTimeout(() => {
                    respostaAlterarDados.innerHTML = ' ';  window.location.reload();
                }, 3000);
                return false
            } else
                // validar email
                if (!email.includes("@") ||
                    !email.includes(".") ||
                    email.startsWith("@") ||
                    email.endsWith("@") ||
                    email.endsWith(".") ||
                    email.indexOf("@") > email.lastIndexOf(".")) {

                    respostaAlterarDados.innerHTML = '<br> <p style="color:red">Campo e-mail inválido!</p>'
                setTimeout(() => {
                    respostaAlterarDados.innerHTML = ' ';  window.location.reload()
                }, 3000); 
            
                    return false

                }
        return true

    }


    function updateDados(nome, email, cpf) {
        var cpf_formatado = cpf.replace(/[./-]/g, "")
        var fks = puxarVariaveis()
        var idUsuario = fks.idUsuario
        console.log(idUsuario)

        if (validacao_info_pessoais() == false) {
            return
        }
        fetch(`/usuarios/updatedados`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                nome: nome,
                idUsuario: idUsuario,
                email: email,
                cpf: cpf_formatado
            })
        })
            .then(res => {
                if (!res.ok) {
                    throw new Error("Erro ao atualizar");
                }
                return res.json();
            })
            .then(data => {

                respostaAlterarDados.innerHTML = '<br> <p style="color:green">Dados alterado com sucesso!</p>'
                setTimeout(() => {
                    respostaAlterarDados.innerHTML = ' ';
                }, 3000);


            })
            .catch(err => {

            })

    }
</script>