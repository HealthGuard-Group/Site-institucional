<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Logs de Acesso</title>
  <link rel="shortcut icon" type="imagex/png" href="../assets/icon/healthguard_icone.png">
  <link rel="stylesheet" href="../css/global.css">
  <link rel="stylesheet" href="../css/menu_bar.css">
  <link rel="stylesheet" href="../css/acessos.css">

</head>

<body onload="validarSessao()">


  <!-- Começo do Menu -->
  <div class="menu-lateral">
    <div class="pai-icones-superiores">
      <div id="logo">
        <img src="../assets/imgs/HealthGuard_icone_BRANCO_fundo_transparente.png" alt="HealthGuard"
          class="icone-logo-pequena">
      </div>
      <br>
      <div class="icone-box" id="monitoramento_redirecionamento">
        <img src="../assets/imgs/icone_monitoramento.png" alt="Foto" class="icone-menu-1">
        <div class="texto-icone oculto">Monitoramento</div>
      </div>
      <hr class="separador">
      <div class="icone-box" id="gestao_redirecionamento">
        <img src="../assets/imgs/icone_gestao_usuarios.png" alt="Foto" class="icone-menu-2">
        <div class="texto-icone oculto">Gestão de funcionários</div>
      </div>
      <hr class="separador">
      <div class="icone-box" id="alertas_redirecionamento">
        <img src="../assets/imgs/icone_alerta.png" alt="Foto" class="icone-menu-3">
        <div class="texto-icone oculto">Histórico de Alertas</div>
      </div>
      <hr class="separador">
      <div class="icone-box" id="gestao_convites">
        <img src="../assets/imgs/icone-convite2.png" alt="Foto" class="icone-menu-2">
        <div class="texto-icone oculto">Convites</div>
      </div>
      <hr class="separador">
      <div class="icone-box" id="suporte_redirecionamento">
        <img src="../assets/imgs/icone_suporte.png" alt="Foto" class="icone-menu-4">
        <div class="texto-icone oculto">Suporte</div>
      </div>
    </div>
    <div class="pai-icones-inferiores">
      <hr class="separador-forte">
      <div class="icone-box-inferior" id="tela_perfil">
        <img src="../assets/imgs/icone_perfil.png" alt="Foto" class="icone-menu-5">
        <div class="texto-icone oculto" id="nome_usuario">Perfil</div>
      </div>
      <hr class="separador">
      <div class="icone-box-inferior" id="sair_conta_redirecionamento">
        <img src="../assets/imgs/icone_log-out.png" alt="Foto" class="icone-menu-6">
        <div class="texto-icone oculto">Sair da conta</div>
      </div>
    </div>
  </div>
  <!-- Fim do Menu -->

  <div class="container-geral">

    <!-- CONTEÚDO PRINCIPAL -->
    <div class="conteudo">

      <h2 class="titulo">Logs de Acesso</h2>
      <div class="texto-topico">
        Histórico de Logs Gerais:
      </div>

      <div class="filtros">

        Filtrar por funcionário:

        <input type="text" placeholder="Ex: Roberto" class="campo-usuario" style="border: solid 1px rgb(92, 92, 92);">


        <button class="botao-aplicar-filtros" onclick="aplicarFiltro()">
          Aplicar filtro
        </button>
      </div>

      <table class="tabela" id="tabela">
        <tr class="linha cabecalho">
          <td class="coluna">Data/Hora</td>
          <td class="coluna">Nome funcionário</td>
          <td class="coluna">E-mail</td>
          <td class="coluna">Descrição</td>
          <td class="coluna">Resultado</td>
          <td class="coluna">Máquina</td>
        </tr>

        <tr class="linha">
          <td class="coluna">2025-11-12 16:14:25</td>
          <td class="coluna">João Silva</td>
          <td class="coluna">joao.silva@email.com</td>
          <td class="coluna">Cadastro Máquina</td>
          <td class="coluna sucesso"><span class="bolinha verde"></span><span style="color: #00aa28;">Sucesso</span>
          </td>
          <td class="coluna">Máquina A-02</td>
        </tr>

        <tr class="linha">
          <td class="coluna">2025-11-12 16:14:25</td>
          <td class="coluna">João Silva</td>
          <td class="coluna">joao.silva@email.com</td>
          <td class="coluna">Cadastro Máquina</td>
          <td class="coluna sucesso"><span class="bolinha verde"></span><span style="color: #00aa28;">Sucesso</span>
          </td>
          <td class="coluna">Máquina A-02</td>
        </tr>

        <tr class="linha">
          <td class="coluna">2025-11-12 16:14:25</td>
          <td class="coluna">João Silva</td>
          <td class="coluna">joao.silva@email.com</td>
          <td class="coluna">Cadastro Máquina</td>
          <td class="coluna sucesso"><span class="bolinha verde"></span><span style="color: #00aa28;">Sucesso</span>
          </td>
          <td class="coluna">Máquina A-02</td>
        </tr>

        <tr class="linha">
          <td class="coluna">2025-11-12 16:14:25</td>
          <td class="coluna">João Silva</td>
          <td class="coluna">joao.silva@email.com</td>
          <td class="coluna">Cadastro Máquina</td>
          <td class="coluna sucesso"><span class="bolinha verde"></span><span style="color: #00aa28;">Sucesso</span>
          </td>
          <td class="coluna">Máquina A-02</td>
        </tr>

        <tr class="linha">
          <td class="coluna">2025-11-12 16:14:25</td>
          <td class="coluna">João Silva</td>
          <td class="coluna">joao.silva@email.com</td>
          <td class="coluna">Cadastro Máquina</td>
          <td class="coluna sucesso"><span class="bolinha verde"></span><span style="color: #00aa28;">Sucesso</span>
          </td>
          <td class="coluna">Máquina A-02</td>
        </tr>

        <tr class="linha">
          <td class="coluna">2025-11-12 16:14:25</td>
          <td class="coluna">João Silva</td>
          <td class="coluna">joao.silva@email.com</td>
          <td class="coluna">Cadastro Máquina</td>
          <td class="coluna sucesso"><span class="bolinha verde"></span><span style="color: #00aa28;">Sucesso</span>
          </td>
          <td class="coluna">Máquina A-02</td>
        </tr>

        <tr class="linha">
          <td class="coluna">2025-11-12 16:14:25</td>
          <td class="coluna">João Silva</td>
          <td class="coluna">joao.silva@email.com</td>
          <td class="coluna">Cadastro Máquina</td>
          <td class="coluna sucesso"><span class="bolinha verde"></span><span style="color: #00aa28;">Sucesso</span>
          </td>
          <td class="coluna">Máquina A-02</td>
        </tr>

      </table>




    </div>
  </div>

  <script src="../js/menu-lateral.js"></script>
  <script src="../js/validarSessao.js"></script>

</body>

</html>

<script>
  var logs = [];

  function buscarDadosLogs() {
    var variaveis = puxarVariaveis()
    console.log(variaveis)
    variaveis = variaveis.idUnidadeAtendimento
    console.log(variaveis)
    tabela.innerHTML = `
        <tr class ="linha cabecalho" style="height: 6vh;">
          <td class="coluna">Data/Hora</td>
          <td class="coluna">Nome do funcionário</td>
          <td class="coluna">E-mail</td>
          <td class="coluna">Descrição</td>
          <td class="coluna">Resultado</td>
        </tr>`
    //<td class="coluna">Máquina</td>
    fetch(`/acessos/buscarDadosLogs/${variaveis}`, {
      method: "GET",
    })
      .then(resposta => {
        return resposta.json();
      })
      .then(resposta => {
        console.log(resposta)
        logs = resposta;
        atualizarTabela(resposta);
      })
      .catch(function (resposta) {
        console.log(`Erro no catch: ${resposta}`);
      });
  }

  function atualizarTabela(dados) {
    console.log("Resposta entrando na função:", dados)
    for (let i = 0; i < dados.length; i++) {

      if (dados[i].statusAcao == "Sucesso") {
        tabela.innerHTML += `
          <tr class="linha">
          <td class="coluna">${formatarData(dados[i].horarioDaAcao)}</td>
          <td class="coluna">${dados[i].nome}</td>
          <td class="coluna">${dados[i].email}</td>
          <td class="coluna">${dados[i].acao}</td>
          <td class="coluna sucesso"><span class="bolinha verde"></span><span style="color: #00aa28;">Sucesso</span>
          </td>
        </tr>`
      }
      //<td class="coluna">Máquina A-02</td>
      else {
        tabela.innerHTML += `
          <tr class="linha">
          <td class="coluna">${formatarData(dados[i].horarioDaAcao)}</td>
          <td class="coluna">${dados[i].nome}</td>
          <td class="coluna">${dados[i].email}</td>
          <td class="coluna">${dados[i].acao}</td>
          <td class="coluna sucesso"><span class="bolinha vermelha"></span><span style="color: #b30000;">Falha</span>
          </td>
        </tr>`
      }
    }

  }

  function formatarData(data) {
    const fuso = {
      timeZone: 'America/Sao_Paulo',
      hour12: false,
      year: '2-digit',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    }
    var data_formatada = new Date(data)
    data_formatada = data_formatada.toLocaleDateString("pt-BR", fuso)
    return data_formatada
  }

  function filtrar(dados) {
    var nomeDigitado = document.querySelector(".campo-usuario").value
    var dados_filtrados = []
    for (let i = 0; i < dados.length; i++) {
      if (formatarTextoParaComparacao(dados[i].nome).includes(formatarTextoParaComparacao(nomeDigitado))) {
        dados_filtrados.push(dados[i])
      }
    }
    console.log("Tamanho dos dados filtrados:", dados_filtrados)
    return dados_filtrados
  }

  function formatarTextoParaComparacao(texto) {
    var texto_formatado = "" + texto
    texto_formatado = texto_formatado.toLowerCase()
    texto_formatado = texto_formatado.replaceAll(" ", "")
    return texto_formatado
  }

  function aplicarFiltro() {
    var logsFiltrados = filtrar(logs);

    tabela.innerHTML = `
    <tr class ="linha cabecalho"  style="height: 6vh;">
      <td class="coluna">Data/Hora</td>
      <td class="coluna">Nome do funcionário</td>
      <td class="coluna">E-mail</td>
      <td class="coluna">Descrição</td>
      <td class="coluna">Resultado</td>
    </tr>`;

    atualizarTabela(logsFiltrados);
  }


</script>