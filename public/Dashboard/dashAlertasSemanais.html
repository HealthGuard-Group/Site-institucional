<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthGuard - Alertas Semanais</title>
    <link rel="shortcut icon" type="imagex/png" href="../assets/icon/healthguard_icone.png">
    <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/menu_bar.css">
    <link rel="stylesheet" href="../css/dashAlertasSemanais.css">

</head>

<body onload="validarSessao()">
    <!-- Começo do Menu -->
    <div class="menu-lateral" id="menu"3
    >
        <div class="pai-icones-superiores">
            <div id="logo">
                <img src="../assets/imgs/HealthGuard_icone_BRANCO_fundo_transparente.png" alt="HealthGuard"
                    class="icone-logo-pequena">
            </div>
            <br>
            <div class="icone-box" id="monitoramento_redirecionamento">
                <img src="../assets/imgs/icone_monitoramento.png" alt="Foto" class="icone-menu-1">
                <div class="texto-icone oculto">Monitoramento</div>
            </div>
            <hr class="separador">
            <div class="icone-box" id="gestao_redirecionamento">
                <img src="../assets/imgs/icone_gestao_usuarios.png" alt="Foto" class="icone-menu-2">
                <div class="texto-icone oculto">Gestão de funcionários</div>
            </div>
            <hr class="separador">
            <div class="icone-box" id="alertas_redirecionamento">
                <img src="../assets/imgs/icone_alerta.png" alt="Foto" class="icone-menu-3">
                <div class="texto-icone oculto">Histórico de Alertas</div>
            </div>
            <hr class="separador">
            <div class="icone-box" id="gestao_convites">
                <img src="../assets/imgs/icone-convite2.png" alt="Foto" class="icone-menu-2">
                <div class="texto-icone oculto">Convites</div>
            </div>
            <hr class="separador">
            <div class="icone-box" id="suporte_redirecionamento">
                <img src="../assets/imgs/icone_suporte.png" alt="Foto" class="icone-menu-4">
                <div class="texto-icone oculto">Suporte</div>
            </div>
        </div>
        <div class="pai-icones-inferiores">
            <hr class="separador-forte">
            <div class="icone-box-inferior" id="tela_perfil">
                <img src="../assets/imgs/icone_perfil.png" alt="Foto" class="icone-menu-5">
                <div class="texto-icone oculto" id="nome_usuario">Perfil</div>
            </div>
            <hr class="separador">
            <div class="icone-box-inferior" id="sair_conta_redirecionamento">
                <img src="../assets/imgs/icone_log-out.png" alt="Foto" class="icone-menu-6">
                <div class="texto-icone oculto">Sair da conta</div>
            </div>
        </div>
    </div>
    <!-- Fim do Menu -->
        <div class="header">
        <div class="header-esquerda">
            <img onclick='history.back()' src="../assets/imgs/seta-esquerda.png" id="bt-voltar">
            <a href="alertasGerais.html">
                <span id="nome_MaquinaDac ">Histórico de alertas</span>
            </a>
            <img src="../assets/imgs/botao_seta_preto.png" alt="">
            <span id="nome_MaquinaDac" >Alertas gerais da semana</span>

            <section class="header_dash">
                
                <div class="header_semanaAtual">
                    <p id="intervaloSemana"></p>
                </div>
            </section>
        </div>
    </div>
    <main class="main_bd_dash">

        <section class="container_kpis_dash">
            <div class="kpi_dash">
                <div class="titulo_kpi">
                    <h2>Total de Alertas da Semana</h2>
                    <span class="tooltip"> <i class='bxr  bx-info-circle'></i>
                        <span class="tooltip-text"> Quantidade total de alertas emitidos nos últimos 7 dias em todas
                            máquinas.</span>
                    </span>
                </div>
                <div class="valor_kpi" id="kpi_totalSemana">
                </div>
            </div>
            <div class="kpi_dash">
                <div class="titulo_kpi">
                    <h2>Desde o Último Alerta</h2>
                    <span class="tooltip"> <i class='bxr  bx-info-circle'></i>
                        <span class="tooltip-text"> Tempo decorrido desde o último alerta registrado para qualquer
                            máquina da unidade.</span>
                    </span>
                </div>
                <div class="valor_kpi" id="kpi_desdeUltimoAlerta">
                </div>
            </div>

            <div class="kpi_dash">
                <div class="titulo_kpi">
                    <h2>Total de Alertas não Verificados</h2>
                    <span class="tooltip"> <i class='bxr  bx-info-circle'></i>
                        <span class="tooltip-text"> Quantidade de alertas que ainda não foram verificados pela
                            equipe.</span>
                    </span>
                </div>
                <div class="valor_kpi" id="kpi_naoVerificados">
                </div>
            </div>

            <div class="kpi_dash">
                <div class="titulo_kpi">
                    <h2>Última Máquina Alertada</h2>
                    <span class="tooltip"> <i class='bxr  bx-info-circle'></i>
                        <span class="tooltip-text">Identificação da máquina que recebeu o alerta mais recente.</span>
                    </span>
                </div>
                <div class="valor_kpi" id="kpi_ultimaMaquina">
                </div>
            </div>

        </section>

        <main class="main_container_dash">
            <div class="container_left_dash">
                <div class="div_graficoSeveridade">
                    <h2>Alertas por Nível de Severidade</h2>
                    <div class="div_grfalertas">
                        <canvas id="grafico_pizza"></canvas>
                    </div>
                </div>
                <div class="div_rankingalertas">
                    <div class="div_ranking">
                        <h2>Top 5 Máquinas com Mais Alertas</h2>
                        <canvas id="grafico_ranking"></canvas>
                    </div>

                </div>
            </div>
            <div class="container_right_dash">
                <div class="div_graficolinha">
                    <h2>Tendência de Alertas por Dia</h2>
                    <canvas id="grafico_linha"></canvas>

                </div>
            </div>
        </main>
    </main>
</body>

<script src="../js/validarSessao.js"></script>
<script src="../js/menu-lateral.js"></script>

<script>


    function formatarData(dia) {
        return dia.toLocaleDateString("pt-BR", { day: "2-digit", month: "2-digit" });
    }
    var hoje = new Date();
    var inicioSemana = new Date(hoje);
    inicioSemana.setDate(hoje.getDate() - 6);

    intervaloSemana.innerHTML = formatarData(inicioSemana) + " ao " + formatarData(hoje);


    function formatarTempo(minutosTotais) {
        var horas = Math.floor(minutosTotais / 60);
        var minutos = minutosTotais % 60;
        if (minutos < 10) {
            minutos = "0" + minutos;
        }
        return horas + "h" + minutos + "min";
    }

    var dataAlerta = []
    dataAlerta.splice(0, dataAlerta.length);
    for (let i = 6; i >= 0; i--) {
        var data = new Date();
        data.setDate(data.getDate() - i);


        var dataFormatada = data.toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: '2-digit'
        });

        dataAlerta.push(dataFormatada);
    }


    function puxarKpisSemana() {
        var fks = puxarVariaveis();
        var idUnidadeAtendimento = fks.idUnidadeAtendimento;
        console.log("idUnidadeAtendimento", idUnidadeAtendimento);

        fetch(`/dashAlertasSemanais/kpis/${idUnidadeAtendimento}`, {
            method: "GET"
        })
            .then(function (res) { return res.json(); })
            .then(function (res) {
                var kpi = res[0];
                kpi_totalSemana.innerHTML = kpi.totalSemana;
                kpi_desdeUltimoAlerta.innerHTML = formatarTempo(kpi.desdeUltimoAlerta);
                kpi_naoVerificados.innerHTML = kpi.naoVerificados;
                kpi_ultimaMaquina.innerHTML = kpi.ultimaMaquina;
            })
            .catch(function (err) {
                console.log("Erro:", err);
            });
    }


    function obterDadosGraficoPizza(idUnidadeAtendimento) {


        fetch(`/dashAlertasSemanais/severidade/${idUnidadeAtendimento}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    var dados = JSON.stringify(resposta)
                    console.log(`Dados recebidos: ${dados}`);
                    dados = JSON.parse(dados)
                    console.log("abluble:", dados)
                    dados.reverse();

                    plotarGraficoPizza(dados);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGraficoPizza(resposta) {
        console.log("Como chegou os dados no plotar", resposta)
        console.log('iniciando plotagem do gráfico...');
        console.log([resposta[0].total, resposta[1].total])
        var dados = {
            labels: ['Atenção', 'Alerta'],
            datasets: [
                {
                    backgroundColor: [
                        'rgba(218, 165, 32, 1)',
                        'rgba(218, 0, 0, 1)'
                    ],
                    data: [resposta[0].total, resposta[1].total]
                }
            ]
        };

        console.log(JSON.stringify(dados));

        var canvas = document.getElementById('grafico_pizza');
        var ctx = canvas.getContext('2d');


        grafico_pizza = new Chart(ctx, {
            type: 'doughnut',
            data: dados,
            options: {
                plugins: {
                    legend: {
                        position: 'right',
                    }
                }
            }
        });
        console.log(grafico_pizza)
        console.log(dados)

    }


    function atualizarGraficoPizza(idUnidadeAtendimento, dados) {
        grafico_pizza.destroy();

        fetch(`/dashAlertasSemanais/severidade/${idUnidadeAtendimento}`, { cache: 'no-store' }).then(function (response) {
            var novo_registros = ""
            if (response.ok) {
                response.json().then(function (novoRegistro) {
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    novo_registros = JSON.stringify(novoRegistro)
                    console.log("Novo registro fudido:", novo_registros)
                    novo_registros = JSON.parse(novo_registros)
                    console.log(`Dados atuais do gráfico: ${novo_registros}`);
                    plotarGraficoPizza(novo_registros)
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function obterDadosGraficoRanking(idUnidadeAtendimento) {
        fetch(`/dashAlertasSemanais/ranking/${idUnidadeAtendimento}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    var dados = JSON.stringify(resposta)
                    console.log(`Dados recebidos: ${dados}`);
                    dados = JSON.parse(dados)
                    console.log("abluble:", dados)

                    plotarGraficoRanking(dados);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    var v_NomesMaquinas = []
    var v_TotalMaquinas = []
    var grafico_ranking = 0


    function plotarGraficoRanking(resposta) {

        for (var i = 0; i < resposta.length; i++) {
            v_NomesMaquinas.push(resposta[i].nomeIdentificacao)
            v_TotalMaquinas.push(resposta[i].totalAlertas)
        }


        console.log("Como chegou os dados no plotar", resposta)
        console.log('iniciando plotagem do gráfico...');
        var dados = {
            labels: v_NomesMaquinas,
            datasets: [{
                data: v_TotalMaquinas,
                backgroundColor: 'rgba(0, 56, 131, 0.8)'
            }]
        };

        console.log(JSON.stringify(dados));

        var canvas = document.getElementById('grafico_ranking');
        var ctx = canvas.getContext('2d');


        grafico_ranking = new Chart(ctx, {
            type: 'bar',
            data: dados,
            options: {
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { display: false }, grid: { display: false } },
                    y: { grid: { display: false } }
                }
            }
        });
        console.log(grafico_ranking)
        console.log(dados)

    }


    function atualizarGraficoRanking(idUnidadeAtendimento) {
        v_NomesMaquinas.splice(0, v_NomesMaquinas.length)
        v_TotalMaquinas.splice(0, v_TotalMaquinas.length)

        fetch(`/dashAlertasSemanais/ranking/${idUnidadeAtendimento}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    var dados = JSON.stringify(resposta)
                    console.log(`Dados recebidos: ${dados}`);
                    dados = JSON.parse(dados)
                    console.log("Dados atualizar ranking:", dados)


                    for (var i = 0; i < resposta.length; i++) {
                        v_NomesMaquinas.push(resposta[i].nomeIdentificacao)
                        v_TotalMaquinas.push(resposta[i].totalAlertas)
                    }

                    grafico_ranking.update()

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function obterDadosGraficoLinha(idUnidadeAtendimento) {
        fetch(`/dashAlertasSemanais/semana/${idUnidadeAtendimento}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    var dados = JSON.stringify(resposta)
                    console.log(`Dados recebidos: ${dados}`);
                    dados = JSON.parse(dados)
                    console.log("Dados do gráfico de linhas:", dados)

                    plotarGraficoLinha(dados);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    var v_TotalAlertas = []
    var grafico_linha = 0

    function plotarGraficoLinha(resposta) {

        for (var i = 0; i < resposta.length; i++) {
            v_TotalAlertas.push(resposta[i].dia_1)
            v_TotalAlertas.push(resposta[i].dia_2)
            v_TotalAlertas.push(resposta[i].dia_3)
            v_TotalAlertas.push(resposta[i].dia_4)
            v_TotalAlertas.push(resposta[i].dia_5)
            v_TotalAlertas.push(resposta[i].dia_6)
            v_TotalAlertas.push(resposta[i].dia_7)
        }
        v_TotalAlertas.reverse()

        console.log("Como chegou os dados no plotar", resposta)
        console.log('iniciando plotagem do gráfico...');
        var dados = {
            labels: dataAlerta,
            datasets: [{
                data: v_TotalAlertas,
                borderColor: "rgba(30, 42, 56, 1)",        
                backgroundColor: "rgba(30, 42, 56, 0.10)", 
                tension: 0.4,
                fill: true,
                pointRadius: 5,
                pointBackgroundColor: "rgba(30, 42, 56, 1)"
            }
            ]
        };

        console.log(JSON.stringify(dados));

        var canvas = document.getElementById('grafico_linha');
        var ctx = canvas.getContext('2d');


        grafico_linha = new Chart(ctx, {
            type: 'line',
            data: dados,
            options: {
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        grid: {
                            color: "rgba(0,0,0,0.05)"
                        }
                    },
                    y: {
                        beginAtZero: false,
                        grid: {
                            color: "rgba(0,0,0,0.05)"
                        }
                    }
                }
            }
        });
        console.log(grafico_linha)
        console.log(dados)

    }


    function atualizarGraficoLinha(idUnidadeAtendimento) {
        v_TotalAlertas.splice(0, v_TotalAlertas.length)

        fetch(`/dashAlertasSemanais/semana/${idUnidadeAtendimento}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    var dados = JSON.stringify(resposta)
                    console.log(`Dados recebidos: ${dados}`);
                    dados = JSON.parse(dados)
                    console.log("Dados atualizar ranking:", dados)


                    for (var i = 0; i < resposta.length; i++) {
                        v_TotalAlertas.push(resposta[i].dia_1)
                        v_TotalAlertas.push(resposta[i].dia_2)
                        v_TotalAlertas.push(resposta[i].dia_3)
                        v_TotalAlertas.push(resposta[i].dia_4)
                        v_TotalAlertas.push(resposta[i].dia_5)
                        v_TotalAlertas.push(resposta[i].dia_6)
                        v_TotalAlertas.push(resposta[i].dia_7)
                    }
                    v_TotalAlertas.reverse()

                    dataAlerta.splice(0, dataAlerta.length);
                    for (let i = 6; i >= 0; i--) {
                        var data = new Date();
                        data.setDate(data.getDate() - i);


                        var dataFormatada = data.toLocaleDateString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit'
                        });

                        dataAlerta.push(dataFormatada);
                    }

                    grafico_linha.update()



                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

</script>

</html>