<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthGuard - Especificação CPU</title>
    <link rel="shortcut icon" type="imagex/png" href="../assets/icon/healthguard_icone.png">

    <link rel="stylesheet" href="../css/menu_bar.css">
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/analisecpu.css">
</head>

<body onload="validarSessao()">
    <!-- Inicio menu lateral  -->
    <div class="menu-lateral" id="menu">
        <div class="pai-icones-superiores">
            <div id="logo">
                <img src="../assets/imgs/HealthGuard_icone_BRANCO_fundo_transparente.png" alt="HealthGuard"
                    class="icone-logo-pequena">
            </div>
            <br>
            <div class="icone-box" id="monitoramento_redirecionamento">
                <img src="../assets/imgs/icone_monitoramento.png" alt="Foto" class="icone-menu-1">
                <div class="texto-icone oculto">Monitoramento</div>
            </div>
            <hr class="separador">
            <div class="icone-box" id="gestao_redirecionamento">
                <img src="../assets/imgs/icone_gestao_usuarios.png" alt="Foto" class="icone-menu-2">
                <div class="texto-icone oculto">Gestão de funcionários</div>
            </div>
            <hr class="separador">
            <div class="icone-box" id="alertas_redirecionamento">
                <img src="../assets/imgs/icone_alerta.png" alt="Foto" class="icone-menu-3">
                <div class="texto-icone oculto">Histórico de Alertas</div>
            </div>
            <hr class="separador">
            <div class="icone-box" id="gestao_convites">
                <img src="../assets/imgs/icone-convite2.png" alt="Foto" class="icone-menu-2">
                <div class="texto-icone oculto">Convites</div>
            </div>
            <hr class="separador">
            <div class="icone-box" id="suporte_redirecionamento">
                <img src="../assets/imgs/icone_suporte.png" alt="Foto" class="icone-menu-4">
                <div class="texto-icone oculto">Suporte</div>
            </div>
        </div>
        <div class="pai-icones-inferiores">
            <hr class="separador-forte">
            <div class="icone-box-inferior" id="tela_perfil">
                <img src="../assets/imgs/icone_perfil.png" alt="Foto" class="icone-menu-5">
                <div class="texto-icone oculto" id="nome_usuario">Perfil</div>
            </div>
            <hr class="separador">
            <div class="icone-box-inferior" id="sair_conta_redirecionamento">
                <img src="../assets/imgs/icone_log-out.png" alt="Foto" class="icone-menu-6">
                <div class="texto-icone oculto">Sair da conta</div>
            </div>
        </div>
    </div>
    <!-- Fim do menu lateral -->
    <div class="header">
        <div class="header-esquerda">
            <img onclick='history.back()' src="../assets/imgs/seta-esquerda.png" id="bt-voltar">
            <a href="monitoramento.html">
                <span id="nome_MaquinaDac ">Monitoramento</span>
            </a>
            <img src="../assets/imgs/botao_seta_preto.png" alt="">
            <a href="grafico1.html">
                <span id="nome_maquina"></span>
                <span id="status_MaquinaDac"> Status: </span>
            </a>
            <img src="../assets/imgs/botao_seta_preto.png" alt="">
            <span id="nome_MaquinaDac">Análise de CPU</span>

        </div>
    </div>
    <div class="conteudo">


        <div id="kpis-superior">
            <div class="kpis" id="Uso-CPU">

                <b>Uso da CPU</b>
                <div class="dados-kpi" id="grafico-cpu"></div>


            </div>

            <div class="kpis" id="Processos">
                <b> Processos Ativos </b>
                <div class="dados-kpi" id="processosKpi">Carregando...</div>

            </div>

            <div class="kpis" id="frequencia">
                <b>Threads em execução </b>
                <div class="dados-kpi">
                    <span id="mhz_max">Carregando...</span>
                </div>


            </div>

            <div class="kpis" id="qtd-alertas">
                <b> Alertas dos ultimos 7 dias </b>
                <div class="dados-kpi" id="alertasKpi">Carregando...</div>

            </div>

        </div>
        <div class="divs-inferior">


            <div class="graficos">
                <div id="titulo-graficos">
                    <b>Acompanhamento em tempo real por Núcleo de CPU </b>
                </div>
                <div id="grafico-heatmap"></div>
            </div>

            <div id="Alertas">
                <header>Ultimos alertas de CPU</header>
                <div id="blocos">
                    Carregando...

                </div>

            </div>

        </div>

    </div>
</body>

</html>
<script src="../js/menu-lateral.js"></script>
<script src="../js/validarSessao.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    var chartCPU;
    var chartHeatmap;

    var idDac = sessionStorage.ID_DAC;
    var fkunidade;

    // Metricas padrao
    var atencao_inicio = 58.1;
    var atencao_fim = 78.5
    var alerta_inicio = 78.6
    var alerta_fim = 100

    // inicia a dashboard puxando oque precisa 
     // inicia a dashboard puxando oque precisa 
    fetch(`/grafico/exibirInfoDac/${idDac}`, {
        method: "GET",
    })
        .then(resposta => {
            return resposta.json();
        })
        .then(resposta => {
            console.log(resposta)
            nome_maquina.innerHTML = `${resposta[0].nomeIdentificacao}`
            fkunidade = resposta[0].fkUnidadeDeAtendimento
            puxarmetricas();
            puxar_primeiros();
            atualizarDados(fkunidade)
            console.log(resposta[0].nomeIdentificacao)
            if (resposta[0].statusDac == "Alerta") {
                status_MaquinaDac.innerHTML = `<p style="color:#b30000">Status: ${resposta[0].statusDac}</p>`
            }
            else if (resposta[0].statusDac == "Ativo") {
                status_MaquinaDac.innerHTML = `<p style="color:green">Status: ${resposta[0].statusDac}</p>`
            }
            else if (resposta[0].statusDac == "Inativo") {
                status_MaquinaDac.innerHTML = `<p style="color:grey">Status: ${resposta[0].statusDac}</p>`
            }
            else if (resposta[0].statusDac == "Em configuração") {
                window.location.href = "monitoramento.html"
            }
        })

        .catch(function (resposta) {
            console.log(`Erro no catch: ${resposta}`);
        });


    function puxarmetricas() {
        fetch(`/analisecpu/puxarMetricas/${idDac}`, {
            method: "GET",
        })
            .then(resposta => {
                if (!resposta.ok) {
                    throw new Error('Erro na requisição');
                }
                return resposta.json();
            })
            .then(resposta => {
                if (resposta.length == 0) {
                    renderizarGraficos(atencao_inicio, atencao_fim, alerta_inicio, alerta_fim)
                } else {
                    atencao_inicio = resposta[0].valorMinimo
                    atencao_fim = resposta[0].valorMaximo

                    alerta_inicio = resposta[1].valorMinimo
                    alerta_fim = resposta[1].valorMaximo
                    renderizarGraficos(atencao_inicio, atencao_fim, alerta_inicio, alerta_fim)
                }


            })
            .catch(function (erro) {
                console.log(`Erro no catch: ${erro}`);
            });
    }



    function atualizarDados(fkunidade) {
        puxar_processos(fkunidade)
        puxar_Threads(fkunidade)
        puxar_CPU(fkunidade)
        puxar_qtdAlertas(fkunidade)
        puxar_porNucleo(fkunidade)
        puxar_dadosAlertas()

        // loop para atualizar kpis
        setTimeout(() => {
            atualizarDados(fkunidade)
        }, 10000);

    }

    function puxar_processos(fkunidade) {
        fetch(`/analisecpu/puxarprocessos/${fkunidade}/${idDac}`, {
            method: "GET",
        })
            .then(resposta => {
                if (!resposta.ok) {
                    throw new Error('Erro na requisição');
                }
                return resposta.json();
            })
            .then(resposta => {
                processosKpi.innerHTML = resposta[0].medidaCapturada
            })
            .catch(function (erro) {
                console.log(`Erro no catch: ${erro}`);
            });
    }

    function puxar_Threads(fkunidade) {
        fetch(`/analisecpu/puxarThreads/${fkunidade}/${idDac}`, {
            method: "GET",
        })
            .then(resposta => {
                if (!resposta.ok) {
                    throw new Error('Erro na requisição');
                }
                return resposta.json();
            })
            .then(resposta => {
                mhz_max.innerHTML = resposta[0].medidaCapturada
            })
            .catch(function (erro) {
                console.log(`Erro no catch: ${erro}`);
            });
    }

    function puxar_CPU(fkunidade) {
        fetch(`/analisecpu/puxarCPU/${fkunidade}/${idDac}`, {
            method: "GET",
        })
            .then(resposta => {
                if (!resposta.ok) {
                    throw new Error('Erro na requisição');
                }
                return resposta.json();
            })
            .then(resposta => {
                var porc_cpu = Number(resposta[0].medidaCapturada);
                var cor = 'green'
                // configurações de alerta para definir cor
                if (porc_cpu > atencao_inicio && porc_cpu < atencao_fim) {
                    cor = '#f1c402'
                } else if (porc_cpu > alerta_inicio) {
                    cor = '#b30000'
                }

                if (chartCPU) {
                    chartCPU.updateOptions({ colors: [cor] });
                    chartCPU.updateSeries([porc_cpu]);
                }


            })
            .catch(function (erro) {
                console.log(`Erro no catch: ${erro}`);
            });
    }

    function puxar_qtdAlertas(fkunidade) {

        fetch(`/analisecpu/puxarQtdAlertas/${fkunidade}/${idDac}`, {
            method: "GET",
        })
            .then(resposta => {
                if (!resposta.ok) {
                    throw new Error('Erro na requisição');
                }
                return resposta.json();
            })
            .then(resposta => {
                alertasKpi.innerHTML = resposta[0].qtdalertas
            })
            .catch(function (erro) {
                console.log(`Erro no catch: ${erro}`);
            });

    }

    function puxar_porNucleo(fkunidade) {
        fetch(`/analisecpu/puxarporNucleo/${fkunidade}/${idDac}`, {
            method: "GET",
        })
            .then(resposta => {
                if (!resposta.ok) {
                    throw new Error('Erro na requisição');
                }
                return resposta.json();
            })
            .then(resposta => {
                console.log("Array:", resposta);
                var string_nucleo = resposta[0].medidaCapturada
                var hora = formatarData(resposta[0].dataCaptura)
                var hora_formatada = hora
                var array_nucleo = JSON.parse(string_nucleo)
                console.log(array_nucleo)
                array_nucleo.forEach((usoCpu, index) => {

                    if (!seriesDados[index]) {
                        seriesDados[index] = {
                            name: 'Núcleo ' + (index + 1),
                            data: []
                        };
                    }
                    seriesDados[index].data.push({
                        x: hora_formatada,
                        y: usoCpu
                    });

                    if (seriesDados[index].data.length > 30) {
                        seriesDados[index].data.shift();
                    }
                });

                chartHeatmap.updateSeries(seriesDados);

            })
            .catch(function (erro) {
                console.log(`Erro no catch: ${erro}`);
            });
    }

    function puxar_dadosAlertas() {
        fetch(`/analisecpu/puxarALERTAS/${idDac}`, {
            method: "GET",
        })
            .then(resposta => {
                if (!resposta.ok) {
                    throw new Error('Erro na requisição');
                }
                return resposta.json();
            })
            .then(resposta => {
                console.log(resposta)
                blocos.innerHTML = ''
                for (let index = 0; index < resposta.length; index++) {
                    var data_formatada = formatarData(resposta[index].dataInicio)
                    if (resposta[index].nomeAlerta == 'Alerta') {
                        blocos.innerHTML += `
                  <div style="background-color: #b30000;" class="alertas" id="alerta_${index}">
                        <h5>Alerta Grave <img src="../assets/imgs/icone_alerta.png" alt="icone-alerta"> </h5>

                        <p> ${data_formatada} </p>
                        <p> Pico: <span id='pico_${index}'>${resposta[index].pico}</span>%</p>
                    </div>
                `
                    } else if (resposta[index].nomeAlerta == 'Atenção') {
                        blocos.innerHTML += `
                <div style="background-color: #daa520;" class="alertas" id="alerta_${index}">
                        <h5>Em Atenção <img src="../assets/imgs/iconeAlerta.png" alt="icone-alerta"> </h5>

                        <p> ${data_formatada}</p>
                        <p> Pico: <span id='pico_1'>${resposta[index].pico}</span>%</p>
                    </div>`
                    }

                }
            })
            .catch(function (erro) {
                console.log(`Erro no catch: ${erro}`);
            });

    }
    function formatarData(dataISO) {
        let data = new Date(dataISO);
        let formatada = data.toLocaleString('pt-BR', {
            timeZone: 'America/Sao_Paulo'
        });
        return formatada.replace(/\//g, '-').replace(',', '');
    }

function puxar_primeiros() {
 fetch(`/analisecpu/iniciarpuxarporNucleo/${idDac}`, {
            method: "GET",
        })
            .then(resposta => {
                if (!resposta.ok) {
                    throw new Error('Erro na requisição');
                }
                return resposta.json();
            })
            .then(resposta => {
                for (let i = 0; i < resposta.length; i++) {
                console.log("Array:", resposta);
                var string_nucleo = resposta[i].medidaCapturada
                var hora = formatarData(resposta[i].dataCaptura)
                var hora_formatada = hora
                var array_nucleo = JSON.parse(string_nucleo)
                console.log(array_nucleo)

                array_nucleo.forEach((usoCpu, index) => {

                    if (!seriesDados[index]) {
                        seriesDados[index] = {
                            name: 'Núcleo ' + (index + 1),
                            data: []
                        };
                    }
                    seriesDados[index].data.push({
                        x: hora_formatada,
                        y: usoCpu
                    });

                    if (seriesDados[index].data.length > 30) {
                        seriesDados[index].data.shift();
                    }
                });

                chartHeatmap.updateSeries(seriesDados);
                }

            })
            .catch(function (erro) {
                console.log(`Erro no catch: ${erro}`);
            });



}
    
    var seriesDados = [];

    function renderizarGraficos(atencao_inicio, atencao_fim, alerta_inicio, alerta_fim) {
        var optionsCPU = {
            series: [0],
            colors: ['green'],
            chart: {
                type: 'radialBar',
                offsetY: -20,
                sparkline: { enabled: true }
            },
            plotOptions: {
                radialBar: {
                    startAngle: -90,
                    endAngle: 90,
                    track: {
                        background: "#e7e7e7",
                        strokeWidth: '100%',
                        margin: 15,
                        dropShadow: { enabled: true, top: 2, left: 0, color: '#444', opacity: 1, blur: 2 }
                    },
                    dataLabels: {
                        name: { show: false },
                        value: { offsetY: -2, fontSize: '4vh' }
                    }
                }
            },
            fill: {
                width: '100%',
                gradient: {
                    shade: 'light',
                    shadeIntensity: 0.4,
                    inverseColors: false,
                    opacityFrom: 1,
                    opacityTo: 1,
                    stops: [0, 50, 53, 91]
                },
            },
            labels: ['Porcentagem da CPU'],
        };

        chartCPU = new ApexCharts(document.querySelector("#grafico-cpu"), optionsCPU);
        chartCPU.render();


        var optionsHeatmap = {
            series: [],
            chart: {
                height: '80%',
                type: 'heatmap',
                width: '100%',
                toolbar: { show: true }
            },
            plotOptions: {
                heatmap: {
                    shadeIntensity: 0.5,
                    radius: 0,
                    useFillColorAsStroke: false,
                    colorScale: {
                        ranges: [
                            {
                                from: 0,
                                to: Number(atencao_inicio) - 0.01,
                                name: 'Ok',
                                color: '#00A100'
                            },
                            {
                                from: atencao_inicio,
                                to: atencao_fim,
                                name: 'atenção',
                                color: '#f1c402'
                            },
                            {
                                from: Number(atencao_fim) - 0.01,
                                to: alerta_fim,
                                name: 'Alerta grave',
                                color: '#b30000'
                            }
                        ]
                    }
                }
            },
            dataLabels: {
                enabled: false
            },
            stroke: {
                width: 1
            },
        };

        chartHeatmap = new ApexCharts(document.querySelector("#grafico-heatmap"), optionsHeatmap);
        chartHeatmap.render();
    }



</script>