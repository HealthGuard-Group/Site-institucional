<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard </title>
  <link rel="shortcut icon" type="imagex/png" href="../assets/icon/healthguard_icone.png">
  <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="../css/global.css">
  <link rel="stylesheet" href="../css/menu_bar.css">
  <link rel="stylesheet" href="../css/dashboardHealthGuard.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="../js/validarSessao.js"></script>

</head>

<body onload="">

  <div class="menu-lateral">
            <div class="pai-icones-superiores">
                <div id="logo">
                    <img src="../assets/imgs/HealthGuard_icone_BRANCO_fundo_transparente.png" alt="HealthGuard"
                        class="icone-logo-pequena">
                </div>
                <br>
                <div class="icone-box" id="monitoramento_redirecionamento">
                    <img src="../assets/imgs/icone_monitoramento.png" alt="Foto" class="icone-menu-1">
                    <div class="texto-icone oculto">Monitoramento</div>
                </div>
                <hr class="separador">
                <div class="icone-box">
                    <img src="../assets/imgs/icone_gestao_usuarios.png" alt="Foto" class="icone-menu-2">
                    <div class="texto-icone oculto">Gestão de usuários</div>
                </div>
                <hr class="separador">
                <div class="icone-box">
                    <img src="../assets/imgs/icone_alerta.png" alt="Foto" class="icone-menu-3">
                    <div class="texto-icone oculto">Histórico de Alertas</div>
                </div>
                <hr class="separador">
                <div class="icone-box">
                    <img src="../assets/imgs/icone_suporte.png" alt="Foto" class="icone-menu-4">
                    <div class="texto-icone oculto">Suporte</div>
                </div>
            </div>
            <div class="pai-icones-inferiores">
                <hr class="separador-forte">
                <div class="icone-box-inferior" id="tela_perfil">
                    <img src="../assets/imgs/icone_perfil.png" alt="Foto" class="icone-menu-5">
                    <div class="texto-icone oculto">Perfil</div>
                </div>
                <hr class="separador">
                <div class="icone-box-inferior" id="sair_conta_redirecionamento">
                    <img src="../assets/imgs/icone_log-out.png" alt="Foto" class="icone-menu-6">
                    <div class="texto-icone oculto">Sair da conta</div>
                </div>
            </div>
        </div>


<div class="menu">
<h2>Visão do Negócio</h2>


<div class="kpi-container">
    <div class="kpi-box">
        <h3>Total de unidades cadastradas</h3>
        <p id="kpi1"></p>
    </div>
    <div class="kpi-box">
        <h3>Total de usuários do sistema</h3>
        <p id="kpi2"></p>
    </div>
    <div class="kpi-box">
        <h3>Porcentagem de usuários que entraram hoje</h3>
        <p id="kpi3"></p>
    </div>
    <div class="kpi-box">
        <h3>Total de chamados abertos nos últimos 7 dias pelos usuários</h3>
        <p>5</p>
    </div>

</div>
<div class="conjunto">
    <div class="chart-container">
        <h3 class="tituloGrafico">Quantidade de acessos à aplicação nos últimos 7 dias</h3>
        <canvas class="grafico" id="graficoAcessos"></canvas>
    </div>

    <div class="rankin-container">

    <h4>Unidades com mais alertas hoje</h4>

    <div class="cabecalho">
        <span></span>
        <span>Nome</span>
        <span>Alertas</span>
        <span>Máquinas</span>
    </div>

    <div class="linha">
        <span>1°</span><span>Unidade Vila Sonia</span><span>176</span><span>98</span>
    </div>

    <div class="linha">
        <span>2°</span><span>Unidade Vila Sonia</span><span>121</span><span>12</span>
    </div>

    <div class="linha">
        <span>3°</span><span>Unidade Vila Sonia</span><span>69</span><span>110</span>
    </div>

    <h4 class="h42">Unidades com mais chamados nesse mês</h4>

    <div class="cabecalho2">
        <span></span>
        <span>Nome</span>
        <span>Chamados</span>
        <span>Usuários</span>
    </div>

    <div class="linha">
        <span>1°</span><span>Unidade Vila Sonia</span><span>12</span><span>90</span>
    </div>

    <div class="linha">
        <span>2°</span><span>Unidade Vila Sonia</span><span>32</span><span>88</span>
    </div>

    <div class="linha">
        <span>3°</span><span>Unidade Vila Sonia</span><span>61</span><span>71</span>
    </div>

</div>

</div>

</div>


<script>
 
    var usuariostotal = 0;
     
    fetch(`/dashhg/empresasCadastradas/`, {
        method: "GET",
    })
        .then(resposta => resposta.json())
        .then(dados => {
            console.log("Resposta da API:", dados[0])
            kpi1.innerHTML = dados[0]['count(idUnidadeDeAtendimento)']
            })
        .catch(err => console.error("Erro no fetch:", err))

    
    fetch(`/dashhg/quantidadeUsuarios/`, {
        method: "GET",
    })
        .then(resposta => resposta.json())
        .then(dados => {
            console.log("Resposta da API:", dados[0])
            usuariostotal = dados[0]['count(idUsuario)']
            kpi2.innerHTML = dados[0]['count(idUsuario)']
            })
        .catch(err => console.error("Erro no fetch:", err))
    
    fetch(`/dashhg/percentual/`, {
        method: "GET",
    })
        .then(resposta => resposta.json())
        .then(dados => {
            console.log("Resposta da API:", dados[0])
            var porcentagem = dados[0]['quantidade_acessos'] / usuariostotal * 100
            kpi3.innerHTML = `${porcentagem.toFixed(2)}%`
            })
        .catch(err => console.error("Erro no fetch:", err))

            
    
   fetch(`/dashhg/usuariosDia`, {
    method: "GET"
    })
        .then(resposta => resposta.json())
        .then(dados => {

            const labels = []
            const dataValores = []
            const dadosPorDia = {}
            for (i = 0; i < dados.length; i++) {
                const diaStr = new Date(dados[i].dia).toISOString().slice(0, 10)
                dadosPorDia[diaStr] = dados[i].quantidade_acessos
            }
            for (i = 6; i >= 0; i--) { 
                const hoje = new Date()
                hoje.setDate(hoje.getDate() - i)

                const mes = ("0" + (hoje.getMonth() + 1)).slice(-2)
                const dia = ("0" + hoje.getDate()).slice(-2)

                const diaFormatado = `${dia}/${mes}`
                const diaISO = `${hoje.getFullYear()}-${mes}-${dia}`

                labels.push(diaFormatado)

                if (dadosPorDia[diaISO] !== undefined) {
                    dataValores.push(dadosPorDia[diaISO])
                } else {
                    dataValores.push(0)
                }
            }
            const ctx = document.getElementById('graficoAcessos').getContext('2d')

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Usuários',
                        data: dataValores,
                        backgroundColor: '#1a1a1a',
                        borderColor: '#1a1a1a',
                        fill: false,
                        tension: 0.2
                        
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { stacked: false },
                        y: { stacked: false, beginAtZero: true }
                    }
                }
            })
        })
        .catch(erro => console.error("Erro ao carregar gráfico:", erro))


</script>

</body>

</html>