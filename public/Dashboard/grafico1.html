<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard </title>
  <link rel="shortcut icon" type="imagex/png" href="../assets/icon/healthguard_icone.png">
  <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="../css/global.css">
  <link rel="stylesheet" href="../css/menu_bar.css">
  <link rel="stylesheet" href="../css/grafico1.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="../js/validarSessao.js"></script>

</head>

<body onload="validarSessao()">

  <!-- Começo do Menu -->
  <div class="menu-lateral">
    <div class="pai-icones-superiores">
      <div id="logo">
        <img src="../assets/imgs/HealthGuard_icone_BRANCO_fundo_transparente.png" alt="HealthGuard"
          class="icone-logo-pequena">
      </div>
      <br>
      <div class="icone-box" id="monitoramento_redirecionamento">
        <img src="../assets/imgs/icone_monitoramento.png" alt="Foto" class="icone-menu-1">
        <div class="texto-icone oculto">Monitoramento</div>
      </div>
      <hr class="separador">
      <div class="icone-box" id="gestao_redirecionamento">
        <img src="../assets/imgs/icone_gestao_usuarios.png" alt="Foto" class="icone-menu-2">
        <div class="texto-icone oculto">Gestão de funcionários</div>
      </div>
      <hr class="separador">
      <div class="icone-box" id="alertas_redirecionamento">
        <img src="../assets/imgs/icone_alerta.png" alt="Foto" class="icone-menu-3">
        <div class="texto-icone oculto">Histórico de Alertas</div>
      </div>
      <hr class="separador">
      <div class="icone-box" id="gestao_convites">
        <img src="../assets/imgs/icone-convite2.png" alt="Foto" class="icone-menu-2">
        <div class="texto-icone oculto">Convites</div>
      </div>
      <hr class="separador">
      <div class="icone-box" id="suporte_redirecionamento">
        <img src="../assets/imgs/icone_suporte.png" alt="Foto" class="icone-menu-4">
        <div class="texto-icone oculto">Suporte</div>
      </div>
    </div>
    <div class="pai-icones-inferiores">
      <hr class="separador-forte">
      <div class="icone-box-inferior" id="tela_perfil">
        <img src="../assets/imgs/icone_perfil.png" alt="Foto" class="icone-menu-5">
        <div class="texto-icone oculto" id="nome_usuario">Perfil</div>
      </div>
      <hr class="separador">
      <div class="icone-box-inferior" id="sair_conta_redirecionamento">
        <img src="../assets/imgs/icone_log-out.png" alt="Foto" class="icone-menu-6">
        <div class="texto-icone oculto">Sair da conta</div>
      </div>
    </div>
  </div>
  <!-- Fim do Menu -->
  <div class="container">
    <div class="conteudo-principal">
      <div class="header-pai">

        <div class="header">
          <div class="header-esquerda">
            <img src="../assets/imgs/seta-esquerda.png" id="bt-voltar">
            <span id="pagina-monitoramento">Monitoramento</span>
            <img src="../assets/imgs/botao_seta_preto.png" alt="">

            <span id="nome_MaquinaDac"></span>
            <span class="status alerta" id="status_MaquinaDac"></span>
          </div>

          <input type="checkbox" id="btn_descricao">
          <!-- <label class="link-descricao" for="btn_descricao">Exibir descrição</label> -->
          <div class="descricao">
            <p id="descricao_MaquinaDac"></p>
          </div>
        </div>

        <div onclick="excluir_maquina()" class="botao-excluir-maquina">
          <img src="../assets/imgs/icone-lixeira2.png">
        </div>
      </div>


      <div class="dashboard-cards">
        <div class="card-monitoramento">

          <div class="title">
            <p>Monitoramento em tempo real </p>
            <span class="tooltip"> <i class='bxr  bx-info-circle'></i>
              <span class="tooltip-text">Painel com a visão geral de todos os componentes sendo monitorados nessa
                máquina e o seu
                desempenho no momento atual</span>
            </span>
          </div>

          <div class="div_componentes">
            <div> <span class="status-dot ok"> </span> Uso de CPU: <strong id="cpu"></strong></div>
            <div> <span class="status-dot alerta-grave"></span>Uso de Memória RAM: <strong id="ram"></strong></div>
            <div> <span id="redeok" class="status-dot ok"></span>Status da Rede: <strong id="rede"></strong></div>
          </div>
          <button class="btn-editar">Editar</button>
        </div>

        <div class="kpi-topo">
          <div class="card alerta-card">
            <div class="title">
              <p>Componente com mais alertas</p>
              <span class="tooltip"> <i class='bxr  bx-info-circle'></i>
                <span class="tooltip-text">Componente monitorado que mais apresentou falhas nas útltimas 24h</span>
              </span>
            </div>
            <div class="text" id="comp_alertas" style="color:#b30000; font-weight: 700;"></div>
          </div>


          <div class="card alerta-card">
            <div class="title">
              <p>Tempo de Atividade</p>
              <span class="tooltip"> <i class='bxr  bx-info-circle'></i>
                <span class="tooltip-text">Tempo ativo total do componente desde o momento que começou o
                  monitoramento </span>
              </span>
            </div>
            <div class="tempo-atividade">15h30min</div>
          </div>


          <div class="card alerta-card">
            <div class="title">
              <p>Quantidade de alertas</p>
              <span class="tooltip"> <i class='bxr  bx-info-circle'></i>
                <span class="tooltip-text">Quantidade de alertas totais obtidos nas últimas 24h</span>
              </span>
            </div>
            <div class="number" id="totalalertas"></div>
          </div>

          <div class="card alerta-card">
            <div class="title">
              <p>Média de alertas por dia</p>
              <span class="tooltip"> <i class='bxr  bx-info-circle'></i>
                <span class="tooltip-text">Calculo de média de todos os alertas diários obtidos nos últimos 6
                  dias</span>
              </span>
            </div>
            <div class="number">35</div>
          </div>
        </div>

        <div class="card-alertas-totais">
          <div class="title">
            <p>Alertas não vistos</p>
            <span class="tooltip"> <i class='bxr  bx-info-circle'></i>
              <span class="tooltip-text">Lista com alertas recentes, agrupados por gravidade.</span>
            </span>
          </div>
          <div class="alerts-list">
            <div class="alerta-grave">
              Alerta Grave <span class="bolinha-grave">1</span> </div>
            <div class="alerta-critico">
              Em atenção
              <span class="bolinha-critico">5</span>
            </div>
          </div>
          <button class="btn-historico" id="link-historico-alertas"
            onclick="window.location.href='alertasIndividuais.html'">Histórico de Alertas <i
              class='bxr  bx-arrow-right-stroke'></i> </button>
        </div>
      </div>


      <div class="botao-sessao">
        <div class="config-alerta">
          <div class="config-left">
            <span class="titulo">
              <strong> Componentes a monitorar: </strong>
            </span>
            <select id="componentSelect" onchange="trocarMonitoramento()">
              <option value="CPU" selected>CPU</option>
              <option value="Memória">Memória RAM</option>
              <option value="Disco">Disco</option>
            </select>

            <div class="config-alertas-status">
              <span class="status-dot alerta-grave"></span> Alerta Grave
              <span class="status-dot alerta-critico"></span> Em atenção
              <span class="status-dot ok"></span> OK
            </div>

            <div class="metrica">
              <div class="metric-lado">Tempo de Inatividade (Nas últimas 24h)</div>
              <div class="number" id="inatividade">8h30min</div>
            </div>
            <div class="metrica">
              <div class="metric-lado">Quantidade de alertas (Nas últimas 24h) </div>
              <div class="number" id="qtdAlertas">7</div>
            </div>
            <div class="metrica">
              <div class="metrica-lado">Tempo médio entre alertas (Nas últimas 24h)</div>
              <div class="number" id="tempoMedio">30min</div>
            </div>
          </div>
          <div class="metricas-valores">
            <span class="grave"> <strong> 88% a 100%</strong></span>
            <span class="critico"> <strong> 72% a 87% </strong></span>
            <span class="ok"><strong> 0% a 71%</strong></span>



          </div>
          <div class="barra-vertical" aria-hidden="true"></div>
        </div>

        <div class="chart-area">
          <div class="chart-header">
            <div class="chart-controls">
              <div id="chartTitle">Alertas emitidos nos últimos 7 dias</div>

              <select id="tipoGraficoTopo" aria-label="Escolher tipo de gráfico" onchange="trocarGraficos()">
                <option value="alertas" selected>Gráfico de Alertas</option>
                <option value="monitoramento">Monitoramento em Tempo Real</option>
              </select>
              <span class="tooltip"> <i class='bxr  bx-info-circle'></i>
                <span class="tooltip-text">Escolha de tipo de gráficos que podem ser selecionados de acordo com os
                  insigths desejados</span>
              </span>
              <div class="redirect-chart">Exibir mais detalhes</div>
            </div>
          </div>

          <canvas id="alertChart"></canvas>

          <canvas id="monitorChart" class="canvas-hidden"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script src="../js/menu-lateral.js"></script>
  <script>
    var idDac = sessionStorage.ID_DAC;
    console.log("Id Dac:", idDac)

    //Redirecionador para Dash individuais
    document.querySelector(".redirect-chart").addEventListener("click", () => {
      var select = componentSelect.value
      if (select == "CPU") {
        window.location.href = "dashboard-cpu.html"
      } else if (select == "Memória") {
        window.location.href = "analiseRAM.html"
      } else if (select == "Disco") {
        window.location.href = "analiseDisco.html"
      }
    })
    //

    fetch(`/grafico/exibirInfoDac/${idDac}`, {
      method: "GET",
    })
      .then(resposta => {
        return resposta.json();
      })
      .then(resposta => {
        console.log(resposta)

        nome_MaquinaDac.innerHTML = `${resposta[0].nomeIdentificacao}`
        if (resposta[0].statusDac == "Alerta") {
          status_MaquinaDac.innerHTML = `<p style="color:#b30000">Status: ${resposta[0].statusDac}</p>`
        }
        else if (resposta[0].statusDac == "Ativo") {
          status_MaquinaDac.innerHTML = `<p style="color:green">Status: ${resposta[0].statusDac}</p>`
        }
        else if (resposta[0].statusDac == "Inativo") {
          status_MaquinaDac.innerHTML = `<p style="color:grey">Status: ${resposta[0].statusDac}</p>`
        }
        else if (resposta[0].statusDac == "Em configuração") {
          window.location.href = "monitoramento.html"
        }

        descricao_MaquinaDac.innerHTML = `${resposta[0].descricao}`
      })

      .catch(function (resposta) {
        console.log(`Erro no catch: ${resposta}`);
      });

    fetch(`/grafico/buscarKpiDac/${idDac}`, {
      method: "GET",
    })
      .then(resposta => {
        return resposta.json();
      })
      .then(resposta => {
        console.log(resposta)
        if (resposta[0] == null) {
          comp_alertas.innerHTML = `Sem componente`
        } else {
          comp_alertas.innerHTML = `${resposta[0].componente}`
        }
      })

      .catch(function (resposta) {
        console.log(`Erro no catch: ${resposta}`);
      });

    fetch(`/grafico/totalAlerta/${idDac}`, {
      method: "GET",
    })
      .then(resposta => {
        return resposta.json();
      })
      .then(resposta => {
        console.log(resposta)

        totalalertas.innerHTML = `${resposta[0].totalAlertas}`
      })


    function atualizarDados() {
      fetch(`/grafico/buscarCpu/${idDac}`, {
        method: "GET",
      }).then(resposta => resposta.json())
        .then(resposta => {
          console.log(resposta);
          cpu.innerHTML = `${resposta[0].medidaCapturada}%`;
        })
        .catch(erro => console.error("Erro:", erro));


      fetch(`/grafico/buscarRam/${idDac}`, {
        method: "GET",
      }).then(resposta => resposta.json())
        .then(resposta => {
          console.log(resposta);
          ram.innerHTML = `${resposta[0].medidaCapturada}%`;
        })
        .catch(erro => console.error("Erro:", erro));

      fetch(`/grafico/buscarRede/${idDac}`, {
        method: "GET",
      }).then(resposta => resposta.json())
        .then(resposta => {
          console.log(resposta);

          if(resposta == ""){
            rede.innerHTML = `Máquina Inativa`
            ram.innerHTML = `Máquina Sem Dados`
            cpu.innerHTML = `Máquina Sem Dados`
              redeok.classList.remove("status-dot", "ok")
              redeok.classList.add("status-dot", "alerta-grave")
              status_MaquinaDac.innerHTML = `<p style="color:color:#b30000">Status: Inativa</p>`
          }

          if (resposta[0].dataCaptura ) {
            const dataServidor = new Date(resposta[0].dataCaptura);
            const agora = new Date();
            const diferenca1 = agora - dataServidor;
            const diferenca2 = diferenca1 / 1000 / 60;

            if (diferenca2 > 1 ) {
              rede.innerHTML = `NÃO CONECTADO`
              ram.innerHTML = `Máquina Inativa`
              cpu.innerHTML = `Máquina inativa`
              redeok.classList.remove("status-dot", "ok")
              redeok.classList.add("status-dot", "alerta-grave")
              status_MaquinaDac.innerHTML = `<p style="color:color:#b30000">Status: Inativa</p>`
            } else {
              rede.innerHTML = `CONECTADO`;
              redeok.classList.remove("status-dot", "alerta-grave")
              redeok.classList.add("status-dot", "ok")
              status_MaquinaDac.innerHTML = `<p style="color:green">Status: Ativa</p>`
            }

          }
        })
        .catch(erro => console.error("Erro:", erro));
    }
    atualizarDados();
    setInterval(atualizarDados, 2000);

    // Variaveis Gráfico
    var ctx = document.getElementById("alertChart").getContext("2d")
    var cty = document.getElementById("monitorChart").getContext("2d")
    var graficoAlerta = ""
    var graficoMonitoramento = ""
    var dadosGraficoAlerta = {
      CPU: {
        grave: [8, 10, 18, 24, 2, 3, 5],
        critico: [7, 12, 16, 20, 5, 10, 2]
      },
      Memória: {
        grave: [5, 8, 10, 15, 3, 1, 0],
        critico: [4, 10, 15, 18, 4, 7, 1]
      },
      Disco: {
        grave: [2, 3, 2, 1, 2, 1, 0],
        critico: [1, 2, 1, 0, 1, 0, 0]
      }
    };
    var dadosMonitoramento = []
    var dataAlerta = []
    var dataMonitoramento = []
    var legendaMonitoramento = ""
    // Funções Auxiliares
    function formatarData(data) {
      const fuso = {
        timeZone: 'America/Sao_Paulo',
        hour12: false
      }
      var data_formatada = new Date(data)
      data_formatada = data_formatada.toLocaleTimeString("pt-BR", fuso)
      return data_formatada
    }
    //
    function plotarGraficosDash() {
      var configuracaoBackgroundMonitoramento = {
        id: 'backgroundColorPlugin',
        beforeDraw: (chart) => {
          const { ctx, chartArea, scales } = chart
          if (!chartArea) return
          const { top, bottom, left, right } = chartArea
          const yScale = scales.y
          const getY = (valor) => yScale.getPixelForValue(valor)
          ctx.save();
          // Valor ideal
          ctx.fillStyle = 'rgba(19, 155, 54, 0.7)'
          ctx.fillRect(left, getY(73), right - left, bottom - getY(71))
          // Valor Atenção
          ctx.fillStyle = 'rgba(243, 190, 58, 0.8)'
          ctx.fillRect(left, getY(87), right - left, getY(73) - getY(87))
          // Valor Alerta
          ctx.fillStyle = 'rgba(220, 23, 23, 0.7)'
          ctx.fillRect(left, top, right - left, getY(87) - top)
          ctx.restore()
        }
      }
      graficoAlerta = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dataAlerta,
          datasets: [
            { label: 'Atenção', data: dadosGraficoAlerta.CPU.grave, backgroundColor: '#b30000', stack: 'Stack 0' },
            { label: 'Alerta', data: dadosGraficoAlerta.CPU.critico, backgroundColor: '#daa520', stack: 'Stack 0' },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true }
          },
          plugins: { legend: { display: false } }
        }
      })
      graficoMonitoramento = new Chart(cty, {
        type: 'line',
        data: {
          labels: dataMonitoramento,
          datasets: [{
            label: legendaMonitoramento,
            data: dadosMonitoramento,
            borderColor: '#000',
            backgroundColor: '#000',
            fill: false,
            tension: 0.25,
            pointRadius: 4,
            pointHoverRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              min: 0, max: 100,
              ticks: {
                stepSize: 10,
                callback: function (valor) {
                  return valor + "%"
                }
              },
              title: { display: true, text: 'Uso (%)' }
            }
          },
          plugins: {
            legend: { display: true },
            title: { display: true, text: 'Monitoramento em Tempo Real' }
          }
        },
        plugins: [configuracaoBackgroundMonitoramento]
      })
    }

    function trocarMonitoramento() {
      var select = document.getElementById("componentSelect").value
      if (select == "CPU") {
        puxarDadosGraficoDash(1)
      } else if (select == "Memória") {
        puxarDadosGraficoDash(6)
      } else if (select == "Disco") {
        puxarDadosGraficoDash(10)
      }
      if (graficoMonitoramento != "") {
        graficoMonitoramento.update()
        graficoAlerta.update()
      }
    }

    function trocarGraficos() {
      var select = document.getElementById("tipoGraficoTopo").value;
      if (select == "alertas") {
        document.getElementById("alertChart").classList.remove("canvas-hidden");
        document.getElementById("monitorChart").classList.add("canvas-hidden");
      } else if (select == "monitoramento") {
        document.getElementById("alertChart").classList.add("canvas-hidden");
        document.getElementById("monitorChart").classList.remove("canvas-hidden");
      }
    }

    function puxarDadosGraficoDash(idMonitoramento) {
      if (idMonitoramento == 1) {
        legendaMonitoramento = "Uso de CPU"
      } else if (idMonitoramento == 2) {
        legendaMonitoramento = "Uso de Memória"
      } else if (idMonitoramento == 3) {
        legendaMonitoramento = "Uso de Disco"
      }
      fetch(`/grafico/puxarDadosGraficoDash/${idDac}/${idMonitoramento}`, {
        method: "GET",
      })
        .then(resposta => {
          return resposta.json();
        })
        .then(resposta => {
          console.log(resposta)
          while (dadosMonitoramento.length != 0) {
            dadosMonitoramento.shift()
            dataMonitoramento.shift()
          }
          for (let i = resposta.length - 1; i >= 0; i--) {
            dadosMonitoramento.push(resposta[i].medidaCapturada)
            dataMonitoramento.push(formatarData(resposta[i].dataCaptura))
          }
          if (graficoMonitoramento == "") {
            plotarGraficosDash()
          } else {
            graficoMonitoramento.update()
          }
        })
        .catch(function (resposta) {
          console.log(`Erro no catch: ${resposta}`);
        });
    }

    function atualizarGraficoMonitoramento() {
      var select = document.getElementById("componentSelect").value
      var idMonitoramento = 0;
      if (select == "CPU") {
        idMonitoramento = 1
      } else if (select == "Memória") {
        idMonitoramento = 6
      } else if (select == "Disco") {
        idMonitoramento = 10
      }
      fetch(`/grafico/atualizarDadosGraficoDashMonitoramento/${idDac}/${idMonitoramento}`, {
        method: "GET",
      })
        .then(resposta => {
          return resposta.json();
        })
        .then(resposta => {
          if (dataMonitoramento[dataMonitoramento.length - 1] != formatarData(resposta[0].dataCaptura)) {
            dadosMonitoramento.push(resposta[0].medidaCapturada)
            dataMonitoramento.push(formatarData(resposta[0].dataCaptura))

            if (dadosMonitoramento.length == 8) {
              dadosMonitoramento.shift()
              dataMonitoramento.shift()
            }
            graficoMonitoramento.update()
          } 
        })
        .catch(function (resposta) {
          console.log(`Erro no catch: ${resposta}`);
        });
    }

    function excluir_maquina() {
      console.log('entrou na função')
      fetch(`/grafico/excluirMaquina/${idDac}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
      })
        .then(res => {
          if (!res.ok) {
            throw new Error("Erro ao remover");
          }
          return res.json();
        })
        .then(data => {

          alert('Maquina removida com sucesso! ')
          setTimeout(() => {
            window.location.href = 'monitoramento.html';
          }, 3000);


        })
        .catch(err => {

        })



    }
  </script>
</body>

</html>